stages:
  # Optional webhook stage: pipelines triggered by external services (like Contentful)
  # will run jobs in this stage first. To trigger from Contentful:
  # 1) In GitLab: Project > Settings > CI/CD > Pipeline triggers -> Add trigger
  #    - Note the trigger token and the project ID
  # 2) Create a Contentful webhook that POSTS to:
  #    https://gitlab.com/api/v4/projects/<PROJECT_ID>/trigger/pipeline?token=<TRIGGER_TOKEN>&ref=main
  #    (set ref=main or the branch you want the pipeline to run on)
  # 3) Optionally include form fields named CONTENTFUL_EVENT or CONTENTFUL_ENTRY_ID
  #    (GitLab will expose those as CI variables inside the pipeline)
  - webhook
  - validate
  - build
  - deploy

variables:
  NODE_ENV: production
  CONTENTFUL_SPACE_ID: $CONTENTFUL_SPACE_ID
  CONTENTFUL_ACCESS_TOKEN: $CONTENTFUL_ACCESS_TOKEN
  CONTENTFUL_PREVIEW_ACCESS_TOKEN: $CONTENTFUL_PREVIEW_ACCESS_TOKEN
  VERCEL_TOKEN: $VERCEL_TOKEN
  VERCEL_PROJECT_ID: $VERCEL_PROJECT_ID
  VERCEL_ORG_ID: $VERCEL_ORG_ID

validate:
  stage: validate
  image: node:20
  variables:
    NODE_ENV: 'development'
    NPM_CONFIG_PRODUCTION: 'false'
  script:
    # Fail early with clear message when required Contentful variables are missing
    - |
      if [ -z "$CONTENTFUL_SPACE_ID" ]; then
        echo "ERROR: CONTENTFUL_SPACE_ID is not set in CI variables"; exit 1
      fi
    - |
      if [ -z "$CONTENTFUL_ACCESS_TOKEN" ]; then
        echo "ERROR: CONTENTFUL_ACCESS_TOKEN is not set in CI variables"; exit 1
      fi
    - |
      if [ -z "$CONTENTFUL_PREVIEW_ACCESS_TOKEN" ]; then
        echo "WARNING: CONTENTFUL_PREVIEW_ACCESS_TOKEN is not set (only needed for draft preview)"
      fi
    - npm ci
    - npm run lint
    - npm run test:coverage
  artifacts:
    paths:
      - coverage
    expire_in: 1 week

# A lightweight job that runs when the pipeline is started via a trigger
# (e.g. from a Contentful webhook). The webhook should POST to the
# GitLab trigger URL with ref=main. You can also include form fields to
# pass through as pipeline variables (for example CONTENTFUL_EVENT).
contentful_publish:
  stage: webhook
  image: busybox:1.36.1
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: always
    - when: never
  script:
    - 'echo "Pipeline started by trigger (CI_PIPELINE_SOURCE=$CI_PIPELINE_SOURCE)"'
    - 'echo "CONTENTFUL_EVENT=${CONTENTFUL_EVENT:-not_set}"'
    - 'echo "CONTENTFUL_ENTRY_ID=${CONTENTFUL_ENTRY_ID:-not_set}"'
    - 'echo "Trigger ref: $CI_COMMIT_REF_NAME"'
    - 'echo "Continuing with pipeline..."'

build:
  stage: build
  image: node:20
  script:
    - npm ci
    - npm run build

deploy:
  stage: deploy
  image: node:20
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: always
    - when: never
  script:
    - |
      if [ -z "$VERCEL_TOKEN" ]; then
        echo "ERROR: VERCEL_TOKEN is not set in CI variables"; exit 1
      fi
    - npm ci
    - npm run build
    - npm install -g vercel
    - |
      # Build the vercel deploy command. Use optional project/org params when present.
      DEPLOY_CMD=(vercel --prod --token "$VERCEL_TOKEN" --confirm)
      # Prefer an explicit project slug/name provided via VERCEL_PROJECT_NAME.
      # If only VERCEL_PROJECT_ID is set and it looks like an API id (starts with prj_),
      # the CLI may not accept it as a project slug. In that case, set VERCEL_PROJECT_NAME
      # to the project slug (from the Vercel project URL: /<team-or-user>/<project-slug>).
      if [ -n "$VERCEL_PROJECT_NAME" ]; then
        echo "Using VERCEL_PROJECT_NAME='$VERCEL_PROJECT_NAME' for explicit project targeting"
        DEPLOY_CMD+=(--project "$VERCEL_PROJECT_NAME")
      elif [ -n "$VERCEL_PROJECT_ID" ]; then
        case "$VERCEL_PROJECT_ID" in
          prj_*)
            echo "VERCEL_PROJECT_ID appears to be an API id (starts with 'prj_')."
            echo "Please set VERCEL_PROJECT_NAME to the project slug (team/project) to target the project explicitly."
            ;;
          *)
            echo "Using VERCEL_PROJECT_ID='$VERCEL_PROJECT_ID' as project slug"
            DEPLOY_CMD+=(--project "$VERCEL_PROJECT_ID")
            ;;
        esac
      else
        echo "No VERCEL_PROJECT_NAME or usable VERCEL_PROJECT_ID set; deploying without explicit project (will use token owner account)"
      fi

      # Only include scope if an explicit VERCEL_SCOPE (team slug) is provided
      if [ -n "$VERCEL_SCOPE" ]; then
        echo "Using VERCEL_SCOPE='$VERCEL_SCOPE' for organization scope"
        DEPLOY_CMD+=(--scope "$VERCEL_SCOPE")
      fi
      echo "Deploying to Vercel (masked token) ..."
      # run deploy but don't let an unexpected non-zero exit code kill the job
      set +e
      "${DEPLOY_CMD[@]}"
      DEPLOY_EXIT=$?
      set -e
      echo "Vercel CLI exit code: ${DEPLOY_EXIT}"
      if [ ${DEPLOY_EXIT} -ne 0 ]; then
        echo "Warning: Vercel CLI returned non-zero exit code ${DEPLOY_EXIT}. The deployment may still have completed."
        echo "You can inspect Vercel dashboard to confirm the deployment status."
      fi
  after_script:
    - |
      if [ -n "$TEAMS_WEBHOOK_URL" ]; then
        echo "TEAMS_WEBHOOK_URL appears set (length: ${#TEAMS_WEBHOOK_URL})"
        if [ "$CI_JOB_STATUS" = "success" ]; then
          payload='{"text":"‚úÖ Deploy conclu√≠do com sucesso no Netlify (GitLab)! üéâ"}'
        else
          payload='{"text":"‚ùå O deploy falhou no GitLab! Verifica o pipeline üòû"}'
        fi
        echo "Sending notification to Teams (masked)..."
        # Capture curl exit and HTTP status without printing the webhook URL
        http_code=$(curl -s -S -o /tmp/teams_resp -w "%{http_code}" -H "Content-Type: application/json" -d "$payload" "$TEAMS_WEBHOOK_URL" || echo "CURL_FAILED")
        echo "curl returned: $http_code"
        if [ -f /tmp/teams_resp ]; then
          echo "Response body (first 200 chars):"
          head -c 200 /tmp/teams_resp | sed -n '1,200p'
        fi
      else
        echo "TEAMS_WEBHOOK_URL not set; skipping notification"
      fi
